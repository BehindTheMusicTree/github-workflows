name: "Redeploy Webhook Call"
on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment (e.g. test)"
        required: true
        type: string
        default: "test"
  workflow_call:
    inputs:
      env:
        required: true
        type: string

jobs:
  check-required-config:
    name: Check required vars and secrets
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.env }}
    steps:
      - name: Validate env
        run: |
          if [[ "${{ inputs.env }}" != "test" && "${{ inputs.env }}" != "prod" ]]; then
            echo "ERROR: env must be 'test' or 'prod' (got: ${{ inputs.env }})"
            exit 1
          fi
        shell: bash

      - name: Check required vars and secrets
        env:
          ENV: ${{ inputs.env }}
          DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
          REDEPLOYMENT_WEBHOOK_PORT: ${{ secrets.REDEPLOYMENT_WEBHOOK_PORT }}
          REDEPLOYMENT_HOOK_ID_BASE: ${{ vars.REDEPLOYMENT_HOOK_ID_BASE }}
          REDEPLOYMENT_WEBHOOK_SECRET: ${{ inputs.env == 'test' && secrets.REDEPLOYMENT_WEBHOOK_SECRET_TEST || (inputs.env == 'prod' && secrets.REDEPLOYMENT_WEBHOOK_SECRET_PROD) }}
        run: |
          missing=""
          [[ -z "$DOMAIN_NAME" ]] && missing="${missing} DOMAIN_NAME"
          [[ -z "$REDEPLOYMENT_WEBHOOK_PORT" ]] && missing="${missing} REDEPLOYMENT_WEBHOOK_PORT"
          [[ -z "$REDEPLOYMENT_HOOK_ID_BASE" ]] && missing="${missing} REDEPLOYMENT_HOOK_ID_BASE"
          [[ -z "$REDEPLOYMENT_WEBHOOK_SECRET" ]] && missing="${missing} REDEPLOYMENT_WEBHOOK_SECRET_${ENV}"
          if [[ -n "$missing" ]]; then
            echo "ERROR: Missing required config:$missing"
            echo "Set variables and secrets in Settings â†’ Environments (or org/repo level). See README."
            exit 1
          fi
          echo "All required vars and secrets are set."
        shell: bash

  call_webhook:
    name: "Call Redeploy Webhook"
    runs-on: ubuntu-latest
    needs: [check-required-config]
    environment:
      name: ${{ inputs.env }}
    steps:
      - name: Call redeploy webhook
        env:
          SERVER_REDEPLOYMENT_WEBHOOK_URL: http://${{ vars.DOMAIN_NAME }}:${{ secrets.REDEPLOYMENT_WEBHOOK_PORT }}/hooks/${{ vars.REDEPLOYMENT_HOOK_ID_BASE }}-${{ inputs.env }}
          REDEPLOYMENT_WEBHOOK_SECRET: ${{ inputs.env == 'test' && secrets.REDEPLOYMENT_WEBHOOK_SECRET_TEST || (inputs.env == 'prod' && secrets.REDEPLOYMENT_WEBHOOK_SECRET_PROD) }}
        run: |
          set +e
          response=$(curl -s -w '\n%{http_code}' -v \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-Secret: $REDEPLOYMENT_WEBHOOK_SECRET" \
            -d '{}' \
            --max-time 15 \
            "${{ env.SERVER_REDEPLOYMENT_WEBHOOK_URL }}")
          curl_exit=$?
          set -e
          if [[ $curl_exit -ne 0 ]]; then
            echo "Webhook call failed (curl exit $curl_exit)."
            echo "Exit 7 = connection refused: nothing listening on host:port, or firewall blocking. Check webhook service on server (systemctl status webhook), port in REDEPLOYMENT_WEBHOOK_PORT, and firewall."
            exit 1
          fi
          http_code=$(echo "$response" | tail -n1)
          response=$(echo "$response" | sed '$d')
          if [[ "$response" != "Redeploying BTMT ecosystem" ]]; then
            echo "ERROR: Webhook call failed with response: $response"
            if [[ "$response" == "Hook not found." ]] || [[ "$http_code" == "404" ]]; then
              echo "REDEPLOYMENT_HOOK_ID_BASE + '-' + env must match the hook id in hooks.json (path is /hooks/<id>-<env>)."
            fi
            exit 1
          fi
        shell: bash
