# Reusable workflow: upload nginx env fragment to pool/nginx.
# Caller must upload an artifact named "nginx-env-fragment" containing one file (the fragment).
# That file is uploaded to pool/nginx/<app_name>.env.
# Vars: WEBHOOK_DIR, WEBHOOK_REDEPLOYMENT_DIR_NAME_BASE, DOMAIN_NAME. Secrets: SERVER_DEPLOY_USERNAME, SERVER_DEPLOY_SSH_PRIVATE_KEY.
name: Deploy Nginx Env Fragment

on:
  workflow_call:
    inputs:
      env:
        description: "Environment (test or prod, lowercase)"
        required: true
        type: string
      app_name:
        description: "App name; fragment is uploaded as pool/nginx/<app_name>.env"
        required: true
        type: string
      artifact_name:
        description: "Artifact name containing the fragment file"
        required: false
        type: string
        default: "nginx-env-fragment"

jobs:
  upload-nginx-env:
    name: Upload nginx env fragment
    runs-on: ubuntu-latest
    env:
      POOL_DIR: ${{ vars.WEBHOOK_DIR }}${{ vars.WEBHOOK_REDEPLOYMENT_DIR_NAME_BASE }}-${{ inputs.env }}/pool/
      SSH_DESTINATION: ${{ secrets.SERVER_DEPLOY_USERNAME }}@${{ vars.DOMAIN_NAME }}
    steps:
      - name: Download nginx env fragment artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}

      - name: Prepare fragment file
        run: |
          set -e
          count=$(find . -type f | wc -l)
          [ "$count" -eq 1 ] || { echo "Expected exactly one file in artifact, got $count"; exit 1; }
          frag="${{ inputs.app_name }}.env"
          cp "$(find . -type f)" "$frag"

      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_DEPLOY_SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ vars.DOMAIN_NAME }} >> ~/.ssh/known_hosts

      - name: Ensure pool/nginx and upload fragment
        run: |
          ssh ${{ env.SSH_DESTINATION }} "mkdir -p ${{ env.POOL_DIR }}nginx"
          scp "${{ inputs.app_name }}.env" ${{ env.SSH_DESTINATION }}:${{ env.POOL_DIR }}nginx/
