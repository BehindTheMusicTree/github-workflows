# Reusable workflow: upload compose part files to the server compose **parts** directory.
# Caller must upload an artifact named "compose-parts" containing the compose part file(s) (.yml or .yaml).
# Files are uploaded to $WEBHOOK_DIR + $WEBHOOK_REDEPLOYMENT_DIR_NAME_BASE + "-" + env + "/" + $DOCKER_COMPOSE_DIR_NAME + "/parts/".
# Vars: WEBHOOK_DIR, WEBHOOK_REDEPLOYMENT_DIR_NAME_BASE, DOCKER_COMPOSE_DIR_NAME, DOMAIN_NAME. Secrets: SERVER_DEPLOY_USERNAME, SERVER_DEPLOY_SSH_PRIVATE_KEY.
name: Deploy Compose Parts

on:
  workflow_call:
    inputs:
      env:
        description: "Environment (test or prod, lowercase)"
        required: true
        type: string
      app_version:
        description: "App version (for logging; optional)"
        required: false
        type: string
        default: ""
      artifact_name:
        description: "Artifact name containing the compose part files"
        required: false
        type: string
        default: "compose-parts"

jobs:
  upload-compose-parts:
    name: Upload compose parts to server
    runs-on: ubuntu-latest
    env:
      SERVER_COMPOSE_PARTS_DIR: ${{ vars.WEBHOOK_DIR }}${{ vars.WEBHOOK_REDEPLOYMENT_DIR_NAME_BASE }}-${{ inputs.env }}/${{ vars.DOCKER_COMPOSE_DIR_NAME }}/parts/
      SSH_DESTINATION: ${{ secrets.SERVER_DEPLOY_USERNAME }}@${{ vars.DOMAIN_NAME }}
    steps:
      - name: Download compose parts artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}

      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_DEPLOY_SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ vars.DOMAIN_NAME }} >> ~/.ssh/known_hosts

      - name: Add suffix -${{ inputs.env }} to container_name in compose files
        run: |
          SUFFIX='-${{ inputs.env }}'
          count=0
          for f in *.yml *.yaml; do
            if [ -f "$f" ]; then
              sed -i -E "s/(container_name:[[:space:]]*[\"']?)([^\"'\n]+)([\"']?)/\1\2${SUFFIX}\3/" "$f"
              count=$((count + 1))
            fi
          done
          if [ "$count" -eq 0 ]; then
            echo "ERROR: No .yml or .yaml compose files found in artifact. Expected at least one."
            exit 1
          fi

      - name: Upload compose part files to server
        run: |
          for f in *.yml *.yaml; do
            [ -f "$f" ] && scp "$f" ${{ env.SSH_DESTINATION }}:${{ env.SERVER_COMPOSE_PARTS_DIR }}
          done
